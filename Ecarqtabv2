#!/bin/bash

INPUT_FILE="resources.txt"
HTML_FILE="/tmp/resource_report.html"
MAIL_TO="ops-team@example.com"
MAIL_FROM="controlm@yourdomain.com"
SUBJECT="Control-M Quantitative Resource Status"

cat <<EOF > "$HTML_FILE"
<html>
<head>
<style>
  body { font-family: Arial, sans-serif; }
  table { border-collapse: collapse; width: 90%; }
  th, td { border: 1px solid #999; padding: 6px; text-align: center; }
  th { background-color: #f2f2f2; }
  .zero { background-color: #ffcccc; }
  .ok { background-color: #ccffcc; }
</style>
</head>
<body>
<h2>Control-M Quantitative Resource Status</h2>
<table>
<tr>
  <th>Resource</th>
  <th>Max-Avail</th>
  <th>Reserved</th>
  <th>Used</th>
  <th>Free</th>
</tr>
EOF

while read -r RESOURCE
do
  [ -z "$RESOURCE" ] && continue

  LINE=$(ecarqtab -list "$RESOURCE" | awk -v r="$RESOURCE" '
    $0 ~ r {
      name=substr($0,1,30)
      max=substr($0,31,10)
      res=substr($0,41,10)
      used=substr($0,51,10)
      free=substr($0,61,10)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", name)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", max)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", res)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", used)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", free)
      print name "|" max "|" res "|" used "|" free
      exit
    }
  ')

  if [ -z "$LINE" ]; then
    cat <<EOF >> "$HTML_FILE"
<tr class="zero">
  <td>$RESOURCE</td>
  <td colspan="4">NOT FOUND</td>
</tr>
EOF
    continue
  fi

  NAME=$(echo "$LINE" | cut -d'|' -f1)
  MAX=$(echo "$LINE"  | cut -d'|' -f2)
  RES=$(echo "$LINE"  | cut -d'|' -f3)
  USED=$(echo "$LINE" | cut -d'|' -f4)
  FREE=$(echo "$LINE" | cut -d'|' -f5)

  CLASS="ok"
  [ "$FREE" = "0" ] && CLASS="zero"

  cat <<EOF >> "$HTML_FILE"
<tr class="$CLASS">
  <td>$NAME</td>
  <td>$MAX</td>
  <td>$RES</td>
  <td>$USED</td>
  <td>$FREE</td>
</tr>
EOF

done < "$INPUT_FILE"

cat <<EOF >> "$HTML_FILE"
</table>
</body>
</html>
EOF

{
  echo "From: $MAIL_FROM"
  echo "To: $MAIL_TO"
  echo "Subject: $SUBJECT"
  echo "MIME-Version: 1.0"
  echo "Content-Type: text/html"
  echo
  cat "$HTML_FILE"
} | sendmail -t
