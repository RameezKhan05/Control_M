#!/bin/bash

# ---------------- CONFIG ----------------
HOST_FILE="hosts.txt"
HTML_REPORT="/tmp/ssh_report.html"
AUTOMATION_KNOWN_HOSTS="/tmp/ssh_known_hosts"
CONNECT_TIMEOUT=10

TO="ops@example.com,admin@example.com,team@example.com"
SUBJECT="SSH Connectivity Report"

# ----------------------------------------

OK_COUNT=0
NOK_COUNT=0

# Start HTML
cat <<EOF > "$HTML_REPORT"
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SSH Connectivity Report</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; }
h2 { text-align:center; }
table {
  border-collapse: collapse;
  width: 90%;
  margin: auto;
  background:#fff;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
}
th {
  background:#333;
  color:#fff;
}
.ok { color: green; font-weight:bold; }
.nok { color: red; font-weight:bold; }
.footer {
  text-align:center;
  font-size:12px;
  color:#666;
}
</style>
</head>
<body>
<h2>SSH Connectivity Report</h2>
<table>
<tr>
  <th>User</th>
  <th>Host</th>
  <th>Status</th>
  <th>Details</th>
</tr>
EOF

# Process hosts
while read -r ENTRY; do
    [[ -z "$ENTRY" ]] && continue

    USER="${ENTRY%@*}"
    HOST="${ENTRY#*@}"

    OUTPUT=$(ssh -n \
      -o BatchMode=yes \
      -o ConnectTimeout=$CONNECT_TIMEOUT \
      -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=$AUTOMATION_KNOWN_HOSTS \
      -o ControlMaster=no \
      -o ControlPath=none \
      "$USER@$HOST" "hostname" 2>&1)

    EXIT_CODE=$?

    if [[ $EXIT_CODE -eq 0 ]]; then
        STATUS="OK"
        CLASS="ok"
        ((OK_COUNT++))

        if echo "$OUTPUT" | grep -qi "permanently added"; then
            DETAILS="SSH successful (host key accepted automatically)"
        else
            DETAILS="SSH connection successful"
        fi
    else
        STATUS="NOK"
        CLASS="nok"
        ((NOK_COUNT++))
        DETAILS=$(echo "$OUTPUT" | head -n 1)
    fi

cat <<EOF >> "$HTML_REPORT"
<tr>
  <td>$USER</td>
  <td>$HOST</td>
  <td class="$CLASS">$STATUS</td>
  <td>$DETAILS</td>
</tr>
EOF

done < "$HOST_FILE"

# Close HTML
cat <<EOF >> "$HTML_REPORT"
</table>
<div class="footer">
Total Hosts: $((OK_COUNT + NOK_COUNT)) |
OK: $OK_COUNT |
NOK: $NOK_COUNT<br>
Generated on $(date)
</div>
</body>
</html>
EOF

# Send mail
(
echo "To: $TO"
echo "Subject: $SUBJECT"
echo "MIME-Version: 1.0"
echo "Content-Type: text/html"
echo
cat "$HTML_REPORT"
) | sendmail -t
